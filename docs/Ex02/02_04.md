---
title: '04: Use Threat Explorer and AIR to scope and stop an attack'
layout: default
nav_order: 4
parent: 'Exercise 02: Email-born Attack Defense with MDO (BEC/Phish â†’ Prevent, Detect, Remediate)'
---


# Task 04: Use Threat Explorer and AIR to scope and stop an attack

---

## Security Architecture Team  

1. **Establish response thresholds**: Decide what qualifies as a containment-level event - for example, when the number of confirmed phish detections or user reports exceeds a specific threshold, a tenant-wide purge will be triggered.

1. **Document intent and escalation path**: Record the agreed-upon response logic in your runbook (who approves AIR actions, when to escalate, when to switch from quarantine to purge).

1. **Verify role-based permissions**:

    {: .note } Informational. This was already handled during provisioning. 

    1. In the leftmost pane, go to **System** > **Permissions**.
    
    1. Confirm that team members have the **Security Administrator** and **Search and Purge** roles needed to execute containment and purge actions.

        {: .important }
        > **Search and Purge** (Email & collaboration): Approve the deletion of malicious messages as recommended by AIR or take manual action on messages in hunting experiences like Threat Explorer.
        >
        > By default, the **Search and Purge** role is assigned only to the following role groups:       
        > - **Data Investigator**
        > - **Organization Management**
        >
        > You can add users to those role groups, or you can create a new role group with the **Search and Purge** role assigned.

1. **Define evidence-collection checklist**: Specify the data to capture (message IDs, sender, recipient count, timestamps, URLs, detonation verdicts) for later use in **Advanced hunting** and post-incident analysis.

---

## Security Engineering and Administration  

1. Go back to Microsoft Edge.

1. In the Defender XDR portal's leftmost pane, go to **Email & collaboration** > **Explorer**.  

1. From the table, select either of the emails you sent, with the following **Subject**:

    **TEST: URL + Attachment Validation (Safe)**

    ![9qj5prp9.jpg](../../media/9qj5prp9.jpg)

    {: .warning }It may take around five minutes for them to appear. Periodically refresh the page.

1. At the top of the flyout pane, select **Open email entity**.

    ![6uxv6wp8.jpg](../../media/6uxv6wp8.jpg)

1. Close any dialogs, then go to the following tabs at the top and observe the results:

    - **Timeline**
    - **Analysis**
    - **Attachments**
    - **URL**
    - **Similar emails**

1. Close the browser tab to return to the flyout pane for the email.

1. At the top of the flyout pane, select **Take action**.

    ![aj13drx1.jpg](../../media/aj13drx1.jpg)

1. On the **Take action** wizard, select **Move or Delete**, select **Soft deleted items**, then select **Next**.

    ![q4zbzhyi.jpg](../../media/q4zbzhyi.jpg)

1. For **Name**, enter `Lab: Email Purge`.

1. Select **Next**, **Submit**, and **Done** through the remaining options.

    {: .note } This will soft delete the email in the system.

1. In the leftmost pane, go to **Investigation & response** > **Action & submission** > **Action center**.  

1. At the top of the page, select the **History** tab to view the soft deleted email.

    ![gpvaxihi.jpg](../../media/gpvaxihi.jpg)

---

## SOC Analyst 

---

### 01: Review the soft-deleted email action

1. In the leftmost pane, go to **Investigation & response** > **Action & submission** > **Action center**.  

1. At the top of the page, select the **History** tab.

    ![wrxc5g0t.jpg](../../media/wrxc5g0t.jpg)

1. Select the line for the **Soft delete emails** action the Engineering team ran.

    ![097tussa.jpg](../../media/097tussa.jpg)

1. At the top of the flyout pane, select **Open Investigation page**.

    ![w0bmajt6.jpg](../../media/w0bmajt6.jpg)

1. Observe the administrative action performed by looking through the tabs: 

    - **Investigation graph**

        ![ksb1a4zl.jpg](../../media/ksb1a4zl.jpg)

    - **Alerts**

        ![9eu0w059.jpg](../../media/9eu0w059.jpg)

    - **Evidence**

        ![wo8z2wlt.jpg](../../media/wo8z2wlt.jpg)

    - **Entities**

        ![2omvzsjm.jpg](../../media/2omvzsjm.jpg)

    - **Log**

        ![pf84yw1w.jpg](../../media/pf84yw1w.jpg)


### 02: Identify which emails were soft-deleted

1. In the leftmost pane, go to **Investigation & response** > **Hunting** > **Advanced hunting**. 

1. Run the following KQL to confirm that the "Stamp X-VIP for mail TO Execs" Exchange Transport Rule successfully triggered on the test email sent to the executive mailbox:

    ```kql2-6.txt
    EmailPostDeliveryEvents
    | where Action == "Soft delete"
    | project
        Timestamp,
        NetworkMessageId,
        RecipientEmailAddress,
        SenderFromAddress,
        ActionType,
        ActionTrigger,
        ActionResult,
        DeliveryLocation,
        EmailDirection
    | order by Timestamp desc
    ```

    ![7y7m5yl6.jpg](../../media/7y7m5yl6.jpg)

    {: .note }
    > Identifies which emails were soft-deleted (manually or via Automated Investigation & Response) after delivery, including who triggered the action, which messages were affected, and when.